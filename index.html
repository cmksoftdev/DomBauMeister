<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>DomBauMeister.js Test</title>
</head>

<body bgcolor="#00BFFF">
    <p id="app"></p>
    <script src="javascript/library.js"></script>
    <script src="javascript/viewtemplates.js"></script>
    <script>

        // Initialize framework
        const dbm = new DomBauMeister({
            rootElement: "app",
            renderOnEventChange: "",
            renderOnModelChange: ""
        });

        // Create view
        const windowtest = getWindowView(
            "app",
            "window1",
            100,
            120,
            "Help", [{
                type: "label",
                style: "height:100px;width:100px;",
                content: "This is the help window."
            }, {
                type: "img",
                style: "position: relative;height:40%;width:40%;margin:auto;",
                extend: {
                    src: "https://upload.wikimedia.org/wikipedia/commons/d/d9/Icon-round-Question_mark.svg"
                }
            }], "---");
        const windowtest2 = getWindowView(
            "app",
            "window2",
            300,
            100,
            "Settings",
            "<canvas id=\"canvas\"/>",
            "---");
        const windoweditor = getWindowView(
            "app",
            "windoweditor",
            300,
            100,
            "Editor", [{
                type: "textarea",
                style: "pointer-events: all;width:100%;height:100%;resize: none;"
            }],
            "---");
        const windowlogger = getWindowView(
            "app4",
            "windowlogger",
            300,
            100,
            "Logger",
            [{
                type: "form",
                style: "height:100px;width:100px;",
                content: [{
                    type: "input",
                    id: "user",
                    extend: {
                        type: "text",
                        maxlength: "30"
                    },
                    style: "height:23px;width:100%;pointer-events: all;margin:15px;",
                }, {
                    type: "input",
                    id: "password",
                    extend: {
                        type: "password",
                        maxlength: "30"
                    },
                    content: "Password",
                    style: "height:23px;width:100%;pointer-events: all;",
                }]
            }],
            "---");
        const login = getOverlayLoginView(
            "app",
            "login",
            "login");

        const icon1 = getIconView(
            "icon1",
            "https://upload.wikimedia.org/wikipedia/commons/8/8e/Icon_tools.svg",
            "icon1",
            50,
            150,
            "Settings",
            "window2_show");
        const icon2 = getIconView(
            "icon2",
            "https://upload.wikimedia.org/wikipedia/commons/d/d9/Icon-round-Question_mark.svg",
            "icon2",
            50,
            50,
            "Help",
            "window1_show");
        const icon3 = getIconView(
            "icon3",
            "https://upload.wikimedia.org/wikipedia/commons/f/f0/Icon-notepad.svg",
            "icon3",
            50,
            250,
            "Editor",
            "windoweditor_show");
        const icon4 = getIconView(
            "icon4",
            "https://upload.wikimedia.org/wikipedia/commons/c/c4/OOjs_UI_icon_article-ltr.svg",
            "icon4",
            50,
            350,
            "Logger",
            "windowlogger_show");

        // Add views to framework
        dbm.addViews([login, windowtest, windowtest2, windoweditor, windowlogger, icon1, icon2, icon3, icon4]);

        // Add timer to settings window
        dbm.addActions([{
            actionName: "timer",
            listeners: [() => {
                var currentdate = new Date();
                var datetime = "Time: "
                    + currentdate.getHours() + ":"
                    + currentdate.getMinutes() + ":"
                    + currentdate.getSeconds();
                dbm.injectModel("window2", {
                    content: datetime
                });
            }],
            interval: 1000,
        }]);
        dbm.addActions([{
            actionName: "login",
            listeners: [(x) => {
                const password = document.getElementById("login_password_input").value;
                const username = document.getElementById("login_user_input").value;
                dbm.injectModel("login", {
                    password: password,
                    user: username,
                });
                //dbm.injectModel("windowlogger", {
                //    isVisible: false,
                //    content: "username: " + username +
                //    "<br>password: " + password,
                //});
                dbm.call("login_on_api", {
                    password: password,
                    user: username,
                });
            }],
        }]);
        dbm.facilitymanager.actionManager.addListener("window2_show", () => {
            dbm.call("timer");
        });
        dbm.facilitymanager.actionManager.addListener("window1_show", () => {
            dbm.call("info_api");
        });
        dbm.facilitymanager.actionManager.addListener("window2_hide", () => {
            dbm.facilitymanager.actionManager.cancelRepeatingAction("timer");
        });

        dbm.addActions([{
            actionName: "login_on_api",
            listeners: [(x) => {
                getRequestAsync("http://cmk.bplaced.com/DomBauMeisterApi.php?command=login&username=" + x.user + "&password=" + x.password, (y) => dbm.call("api_login_request_done", y));
            }]
        }]);

        dbm.addActions([{
            actionName: "info_api",
            listeners: [() => {
                const model = dbm.facilitymanager.models.find((x) => x.name === "login").model.get();
                getRequestAsync("http://cmk.bplaced.com/DomBauMeisterApi.php?command=info&username=" + model.user + "&password=" + model.password, (y) => dbm.call("api_info_request_done", y));
            }]
        }]);

        dbm.addActions([{
            actionName: "api_login_request_done",
            listeners: [(x) => {
                dbm.injectModel("login", {
                    isVisible: false,
                });
                dbm.injectModel("windowlogger", { content: "IP " + JSON.parse(x).ip});
            }]
        }]);

        dbm.addActions([{
            actionName: "api_info_request_done",
            listeners: [(x) => {
                dbm.injectModel("login", {
                    isVisible: false,
                });
                dbm.injectModel("window1", { content: x });
            }]
        }]);

        // Start framework
        dbm.start();
        //document.body.appendChild("login_form");
    </script>
</body>
</html>